<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LPD Combination Finder</title>
    <style>
        body {
            font-family: sans-serif;
            padding: 20px;
        }
        label {
            display: block;
            margin-top: 10px;
            margin-bottom: 5px;
            font-weight: bold;
        }
        textarea {
            width: 90%;
            min-height: 150px;
            margin-bottom: 10px;
            font-family: monospace;
        }
        input[type="number"] {
            padding: 8px;
            margin-bottom: 10px;
            width: 100px; /* Adjust width as needed */
        }
        button {
            padding: 10px 15px;
            cursor: pointer;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            margin-top: 10px;
        }
        button:hover {
            background-color: #0056b3;
        }
        #results {
            margin-top: 20px;
            padding: 15px;
            border: 1px solid #ccc;
            background-color: #f9f9f9;
            white-space: pre-wrap; /* Preserve formatting */
            font-family: monospace;
        }
        .error {
            color: red;
            font-weight: bold;
        }
         .info {
            color: blue;
        }
        .input-group {
            margin-bottom: 15px;
        }
    </style>
</head>
<body>

    <h1>Find Combination of LPDs</h1>

    <div class="input-group">
        <label for="tableData">Table Data (Details + Amount, one per line):</label>
        <textarea id="tableData" placeholder="Example:
Tempero Para Aves	3000
Pimenta Branca Moída	3000
Pimenta Preta Moída	4000
Alho Poró	5000
..."></textarea>
    </div>

    <div class="input-group">
        <label for="targetSum">Target Sum:</label>
        <input type="number" id="targetSum" placeholder="e.g., 37000">
    </div>

    <div class="input-group">
        <label for="combinationSize">Number of LPDs in Combination:</label>
        <input type="number" id="combinationSize" value="4" min="2">
    </div>


    <button onclick="findCombination()">Find Combination</button>

    <div id="results">Results will appear here...</div>

    <script>
        // --- Recursive Combination Finder ---
        // lpdValues: array of {value: number, frequency: number} objects
        // target: the target sum
        // k: the number of elements required in the combination
        // startIndex: the index in lpdValues to start searching from (avoids duplicates)
        // currentCombination: the combination built so far
        function findSumCombinationRecursive(lpdValues, target, k, startIndex, currentCombination) {
            // Base Case 1: Combination complete
            if (currentCombination.length === k) {
                const currentSum = currentCombination.reduce((sum, item) => sum + item, 0);
                if (currentSum === target) {
                    return currentCombination; // Found a match!
                }
                return null; // Combination built, but sum doesn't match
            }

            // Base Case 2: Not enough remaining elements to form a k-sized combination
            if (startIndex >= lpdValues.length || lpdValues.length - startIndex < k - currentCombination.length) {
                return null;
            }

            // Recursive Step: Try including and excluding the element at startIndex
            for (let i = startIndex; i < lpdValues.length; i++) {
                // Try including lpdValues[i]
                currentCombination.push(lpdValues[i].value);
                const result = findSumCombinationRecursive(lpdValues, target, k, i + 1, currentCombination); // i + 1 ensures distinct elements

                if (result) {
                    return result; // Found a solution down this path
                }

                // Backtrack: Remove the element and try the next one in the loop
                currentCombination.pop();
            }

            return null; // No combination found starting from this startIndex
        }
        // --- End Recursive Combination Finder ---


        function findCombination() {
            const tableDataInput = document.getElementById('tableData').value.trim();
            const targetSumInput = document.getElementById('targetSum').value;
            const combinationSizeInput = document.getElementById('combinationSize').value;
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = 'Processing...'; // Clear previous results

            // --- Input Validation ---
            if (!tableDataInput) {
                resultsDiv.innerHTML = '<span class="error">Error: Table data cannot be empty.</span>';
                return;
            }
            if (!targetSumInput) {
                resultsDiv.innerHTML = '<span class="error">Error: Target sum cannot be empty.</span>';
                return;
            }
             if (!combinationSizeInput) {
                resultsDiv.innerHTML = '<span class="error">Error: Number of LPDs cannot be empty.</span>';
                return;
            }

            const initialTargetSum = parseInt(targetSumInput);
            const combinationSize = parseInt(combinationSizeInput);

            if (isNaN(initialTargetSum)) {
                 resultsDiv.innerHTML = '<span class="error">Error: Invalid Target Sum. Please enter a number.</span>';
                return;
            }
             if (isNaN(combinationSize) || combinationSize < 2) {
                 resultsDiv.innerHTML = `<span class="error">Error: Invalid Number of LPDs. Please enter a number greater than or equal to 2.</span>`;
                return;
            }
            // --- End Input Validation ---


            // 1. Parse Table Data and Calculate LPDs + Frequencies
            const lines = tableDataInput.split('\n');
            const lpdFrequencies = {};
            let parseErrors = [];

            lines.forEach((line, index) => {
                line = line.trim();
                if (!line) return;
                let parts = line.split('\t');
                if (parts.length < 2) parts = line.split(/\s+/);
                if (parts.length < 2) {
                    parseErrors.push(`Line ${index + 1}: Could not properly split into Details and Amount.`); return;
                }
                const amountStr = parts[parts.length - 1];
                const amount = parseInt(amountStr);
                if (isNaN(amount)) { parseErrors.push(`Line ${index + 1}: Amount "${amountStr}" is not a valid number.`); return; }
                if (amount <= 0) { parseErrors.push(`Line ${index + 1}: Amount "${amount}" must be positive.`); return; }
                if (amount % 2 !== 0) { parseErrors.push(`Line ${index + 1}: Amount "${amount}" must be an even number to calculate LPD.`); return; }
                const lpd = amount / 2;
                lpdFrequencies[lpd] = (lpdFrequencies[lpd] || 0) + 1;
            });

             if (parseErrors.length > 0) {
                resultsDiv.innerHTML = `<span class="error">Errors parsing table data:</span>\n${parseErrors.join('\n')}`;
                return;
            }

            // 2. Prepare LPD List for Selection
            const uniqueLpdList = Object.entries(lpdFrequencies)
                .map(([lpd, freq]) => ({ value: parseInt(lpd), frequency: freq }))
                .sort((a, b) => b.frequency - a.frequency); // Sort descending by frequency (optional, but might find common ones faster)

            if (uniqueLpdList.length < combinationSize) {
                 resultsDiv.innerHTML = `<span class="error">Error: Need at least ${combinationSize} unique valid even Amounts in the table to find a combination of ${combinationSize} LPDs. Found only ${uniqueLpdList.length}.</span>`;
                 return;
            }


            // 3. Iterative Search with Target Adjustment
            const MAX_INITIAL_TRIES = 10; // Give the exact target a few tries (though once is enough with recursion)
            const MAX_ADJUSTMENT_ITERATIONS = 50; // Limit how far we search around the target
            let currentSum = initialTargetSum;
            let attempts = 0;
            let adjustment = 500;
            let direction = 1; // 1 for increase, -1 for decrease
            let foundCombination = null;
            let searchLog = [`Searching for a combination of ${combinationSize} LPDs summing to: ${initialTargetSum}`];


            while (attempts < MAX_INITIAL_TRIES + MAX_ADJUSTMENT_ITERATIONS * 2) {
                 if (attempts > 0) {
                      searchLog.push(`Attempt ${attempts + 1}: Trying sum ${currentSum}...`);
                 }

                 // Call the recursive finder
                 foundCombination = findSumCombinationRecursive(uniqueLpdList, currentSum, combinationSize, 0, []);

                 if (foundCombination) {
                    searchLog.push(`\nSuccess! Found combination for sum ${currentSum}.`);
                    break; // Exit loop
                 }

                 attempts++;

                 // Start adjusting only after initial tries
                 if (attempts >= MAX_INITIAL_TRIES) {
                     currentSum = initialTargetSum + direction * adjustment;
                     direction *= -1;
                     if (direction === 1) { // If direction is positive again, increase adjustment
                         adjustment += 500;
                     }
                 }
            }


            // 4. Display Results
            if (foundCombination) {
                resultsDiv.innerHTML = searchLog.join('\n') + `\n\nFound Combination (${combinationSize} LPDs): [${foundCombination.sort((a,b) => a-b).join(', ')}] \nSum: ${currentSum}`; // Sort for consistent display
            } else {
                 resultsDiv.innerHTML = searchLog.join('\n') + `\n\n<span class="error">No combination of ${combinationSize} distinct LPDs found summing to ${initialTargetSum} or nearby values within the search limit.</span>\n\nUnique LPDs (Value: Frequency):\n` + uniqueLpdList.map(item => `${item.value}: ${item.frequency}`).join('\n');
            }
        }
    </script>

</body>
</html>